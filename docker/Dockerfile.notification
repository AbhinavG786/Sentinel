FROM node:20-alpine

WORKDIR /app

# Copy root first
COPY package.json package-lock.json ./

# ADD THIS: copy your shared package
COPY packages/shared-utils ./packages/shared-utils

# Copy root tsconfig AFTER shared-utils so it doesnâ€™t override local tsconfig resolution
COPY tsconfig.json ./

# Copy ONLY what this service needs
COPY src/services/notification-service ./src/services/notification-service

# Copy service tsconfig if it exists
COPY src/services/notification-service/tsconfig.json ./src/services/notification-service/tsconfig.json

# Install root + workspace deps so shared-utils becomes a real package
RUN npm install

# Build shared utils
RUN npm run build --workspace=packages/shared-utils

# Install deps only for this service
RUN npm install --workspace=src/services/notification-service

# Build
RUN npm run build --workspace=src/services/notification-service

EXPOSE 4004

CMD ["node", "src/services/notification-service/dist/server.js"]